{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.33.93.31351",
      "templateHash": "17290464070981437590"
    }
  },
  "parameters": {
    "solutionPrefix": {
      "type": "string",
      "minLength": 3,
      "maxLength": 6,
      "metadata": {
        "description": "Prefix Name"
      }
    },
    "cosmosLocation": {
      "type": "string",
      "metadata": {
        "description": "CosmosDB Location"
      }
    }
  },
  "variables": {
    "resourceGroupLocation": "[resourceGroup().location]",
    "solutionLocation": "[variables('resourceGroupLocation')]",
    "baseUrl": "https://raw.githubusercontent.com/microsoft/Build-your-own-copilot-Solution-Accelerator/main/ClientAdvisor/",
    "appversion": "latest",
    "functionAppSqlPrompt": "A valid T-SQL query to find {query} for tables and columns provided below:\r\n    1. Table: Clients\r\n    Columns: ClientId,Client,Email,Occupation,MaritalStatus,Dependents\r\n    2. Table: InvestmentGoals\r\n    Columns: ClientId,InvestmentGoal\r\n    3. Table: Assets\r\n    Columns: ClientId,AssetDate,Investment,ROI,Revenue,AssetType\r\n    4. Table: ClientSummaries\r\n    Columns: ClientId,ClientSummary\r\n    5. Table: InvestmentGoalsDetails\r\n    Columns: ClientId,InvestmentGoal,TargetAmount,Contribution\r\n    6. Table: Retirement\r\n    Columns: ClientId,StatusDate,RetirementGoalProgress,EducationGoalProgress\r\n    7.Table: ClientMeetings\r\n    Columns: ClientId,ConversationId,Title,StartTime,EndTime,Advisor,ClientEmail\r\n    Use Investement column from Assets table as value always.\r\n    Assets table has snapshots of values by date. Do not add numbers across different dates for total values.\r\n    Do not use client name in filter.\r\n    Do not include assets values unless asked for.\r\n    Always use ClientId = {clientid} in the query filter.\r\n    Always return client name in the query.\r\n    Only return the generated sql query. do not return anything else",
    "functionAppCallTranscriptSystemPrompt": "You are an assistant who provides wealth advisors with helpful information to prepare for client meetings.\r\n  You have access to the clientâ€™s meeting call transcripts.\r\n  You can use this information to answer questions about the clients",
    "functionAppStreamTextSystemPrompt": "You are a helpful assistant to a wealth advisor.\r\n  Do not answer any questions not related to wealth advisors queries.\r\n  If the client name and client id do not match, only return - Please only ask questions about the selected client or select another client to inquire about their details. do not return any other information.\r\n  Only use the client name returned from database in the response.\r\n  If you cannot answer the question, always return - I cannot answer this question from the data available. Please rephrase or add more details.\r\n  ** Remove any client identifiers or ids or numbers or ClientId in the final response."
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy_managed_identity",
      "resourceGroup": "[resourceGroup().name]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionPrefix')]"
          },
          "solutionLocation": {
            "value": "[variables('solutionLocation')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "4123789684929590981"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string",
              "metadata": {
                "description": "Solution Location"
              }
            },
            "miName": {
              "type": "string",
              "defaultValue": "[format('{0}-managed-identity', parameters('solutionName'))]",
              "metadata": {
                "description": "Name"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[parameters('miName')]",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(resourceGroup().id, resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('miName')), resourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635'))]",
              "properties": {
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('miName')), '2023-01-31').principalId]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('miName'))]"
              ]
            }
          ],
          "outputs": {
            "managedIdentityOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('miName'))]",
                "objectId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('miName')), '2023-01-31').principalId]",
                "name": "[parameters('miName')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy_cosmos_db",
      "resourceGroup": "[resourceGroup().name]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionPrefix')]"
          },
          "solutionLocation": {
            "value": "[parameters('cosmosLocation')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "7996681102160459059"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string"
            },
            "accountName": {
              "type": "string",
              "defaultValue": "[format('{0}-cosmos', parameters('solutionName'))]",
              "metadata": {
                "description": "Name"
              }
            },
            "databaseName": {
              "type": "string",
              "defaultValue": "db_conversation_history"
            },
            "collectionName": {
              "type": "string",
              "defaultValue": "conversations"
            },
            "containers": {
              "type": "array",
              "defaultValue": [
                {
                  "name": "[parameters('collectionName')]",
                  "id": "[parameters('collectionName')]",
                  "partitionKey": "/userId"
                }
              ]
            },
            "kind": {
              "type": "string",
              "defaultValue": "GlobalDocumentDB",
              "allowedValues": [
                "GlobalDocumentDB",
                "MongoDB",
                "Parse"
              ]
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "resources": [
            {
              "copy": {
                "name": "database::list",
                "count": "[length(parameters('containers'))]"
              },
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2022-05-15",
              "name": "[format('{0}/{1}/{2}', split(format('{0}/{1}', parameters('accountName'), parameters('databaseName')), '/')[0], split(format('{0}/{1}', parameters('accountName'), parameters('databaseName')), '/')[1], parameters('containers')[copyIndex()].name)]",
              "properties": {
                "resource": {
                  "id": "[parameters('containers')[copyIndex()].id]",
                  "partitionKey": {
                    "paths": [
                      "[parameters('containers')[copyIndex()].partitionKey]"
                    ]
                  }
                },
                "options": {}
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', split(format('{0}/{1}', parameters('accountName'), parameters('databaseName')), '/')[0], split(format('{0}/{1}', parameters('accountName'), parameters('databaseName')), '/')[1])]"
              ]
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2022-08-15",
              "name": "[parameters('accountName')]",
              "kind": "[parameters('kind')]",
              "location": "[parameters('solutionLocation')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "consistencyPolicy": {
                  "defaultConsistencyLevel": "Session"
                },
                "locations": [
                  {
                    "locationName": "[parameters('solutionLocation')]",
                    "failoverPriority": 0,
                    "isZoneRedundant": false
                  }
                ],
                "databaseAccountOfferType": "Standard",
                "enableAutomaticFailover": false,
                "enableMultipleWriteLocations": false,
                "disableLocalAuth": true,
                "apiProperties": "[if(equals(parameters('kind'), 'MongoDB'), createObject('serverVersion', '4.0'), createObject())]",
                "capabilities": [
                  {
                    "name": "EnableServerless"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
              "apiVersion": "2022-05-15",
              "name": "[format('{0}/{1}', parameters('accountName'), parameters('databaseName'))]",
              "properties": {
                "resource": {
                  "id": "[parameters('databaseName')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('accountName'))]"
              ]
            }
          ],
          "outputs": {
            "cosmosOutput": {
              "type": "object",
              "value": {
                "cosmosAccountName": "[parameters('accountName')]",
                "cosmosDatabaseName": "[parameters('databaseName')]",
                "cosmosContainerName": "[parameters('collectionName')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy_storage_account",
      "resourceGroup": "[resourceGroup().name]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionPrefix')]"
          },
          "solutionLocation": {
            "value": "[variables('solutionLocation')]"
          },
          "managedIdentityObjectId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_managed_identity'), '2022-09-01').outputs.managedIdentityOutput.value.objectId]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "3788062353340084517"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string",
              "metadata": {
                "description": "Solution Location"
              }
            },
            "saName": {
              "type": "string",
              "defaultValue": "[format('{0}storageaccount', parameters('solutionName'))]",
              "metadata": {
                "description": "Name"
              }
            },
            "managedIdentityObjectId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2022-09-01",
              "name": "[parameters('saName')]",
              "location": "[parameters('solutionLocation')]",
              "sku": {
                "name": "Standard_LRS",
                "tier": "Standard"
              },
              "kind": "StorageV2",
              "properties": {
                "minimumTlsVersion": "TLS1_2",
                "allowBlobPublicAccess": false,
                "isHnsEnabled": true,
                "networkAcls": {
                  "bypass": "AzureServices",
                  "virtualNetworkRules": [],
                  "ipRules": [],
                  "defaultAction": "Allow"
                },
                "supportsHttpsTrafficOnly": true,
                "encryption": {
                  "services": {
                    "file": {
                      "keyType": "Account",
                      "enabled": true
                    },
                    "blob": {
                      "keyType": "Account",
                      "enabled": true
                    }
                  },
                  "keySource": "Microsoft.Storage"
                },
                "accessTier": "Hot",
                "allowSharedKeyAccess": false
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}/{1}', parameters('saName'), 'default')]",
              "properties": {
                "cors": {
                  "corsRules": []
                },
                "deleteRetentionPolicy": {
                  "allowPermanentDelete": false,
                  "enabled": false
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('saName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}/{1}/{2}', parameters('saName'), 'default', 'data')]",
              "properties": {
                "defaultEncryptionScope": "$account-encryption-key",
                "denyEncryptionScopeOverride": false,
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('saName'), 'default')]",
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('saName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(resourceGroup().id, parameters('managedIdentityObjectId'), resourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe'))]",
              "properties": {
                "principalId": "[parameters('managedIdentityObjectId')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
                "principalType": "ServicePrincipal"
              }
            }
          ],
          "outputs": {
            "storageAccountOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.Storage/storageAccounts', parameters('saName'))]",
                "name": "[parameters('saName')]",
                "uri": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('saName')), '2022-09-01').primaryEndpoints.web]",
                "dfs": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('saName')), '2022-09-01').primaryEndpoints.dfs]",
                "storageAccountName": "[parameters('saName')]",
                "key": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('saName')), '2021-04-01').keys[0].value]",
                "connectionString": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix={2}', parameters('saName'), listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('saName')), '2022-09-01').keys[0].value, environment().suffixes.storage)]",
                "dataContainer": "data"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_managed_identity')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy_sql_db",
      "resourceGroup": "[resourceGroup().name]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionPrefix')]"
          },
          "solutionLocation": {
            "value": "[variables('solutionLocation')]"
          },
          "managedIdentityObjectId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_managed_identity'), '2022-09-01').outputs.managedIdentityOutput.value.objectId]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "7560908687482299570"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string"
            },
            "managedIdentityObjectId": {
              "type": "string"
            },
            "serverName": {
              "type": "string",
              "defaultValue": "[format('{0}-sql-server', parameters('solutionName'))]",
              "metadata": {
                "description": "The name of the SQL logical server."
              }
            },
            "sqlDBName": {
              "type": "string",
              "defaultValue": "[format('{0}-sql-db', parameters('solutionName'))]",
              "metadata": {
                "description": "The name of the SQL Database."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[parameters('solutionLocation')]",
              "metadata": {
                "description": "Location for all resources."
              }
            },
            "administratorLogin": {
              "type": "string",
              "defaultValue": "sqladmin",
              "metadata": {
                "description": "The administrator username of the SQL logical server."
              }
            },
            "administratorLoginPassword": {
              "type": "securestring",
              "defaultValue": "TestPassword_1234",
              "metadata": {
                "description": "The administrator password of the SQL logical server."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Sql/servers",
              "apiVersion": "2023-08-01-preview",
              "name": "[parameters('serverName')]",
              "location": "[parameters('location')]",
              "kind": "v12.0",
              "properties": {
                "administratorLogin": "[parameters('administratorLogin')]",
                "administratorLoginPassword": "[parameters('administratorLoginPassword')]",
                "publicNetworkAccess": "Enabled",
                "version": "12.0",
                "restrictOutboundNetworkAccess": "Disabled"
              }
            },
            {
              "type": "Microsoft.Sql/servers/firewallRules",
              "apiVersion": "2023-08-01-preview",
              "name": "[format('{0}/{1}', parameters('serverName'), 'AllowSpecificRange')]",
              "properties": {
                "startIpAddress": "0.0.0.0",
                "endIpAddress": "255.255.255.255"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', parameters('serverName'))]"
              ]
            },
            {
              "type": "Microsoft.Sql/servers/firewallRules",
              "apiVersion": "2023-08-01-preview",
              "name": "[format('{0}/{1}', parameters('serverName'), 'AllowAllWindowsAzureIps')]",
              "properties": {
                "startIpAddress": "0.0.0.0",
                "endIpAddress": "0.0.0.0"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', parameters('serverName'))]"
              ]
            },
            {
              "type": "Microsoft.Sql/servers/databases",
              "apiVersion": "2023-08-01-preview",
              "name": "[format('{0}/{1}', parameters('serverName'), parameters('sqlDBName'))]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "GP_S_Gen5",
                "tier": "GeneralPurpose",
                "family": "Gen5",
                "capacity": 2
              },
              "kind": "v12.0,user,vcore,serverless",
              "properties": {
                "collation": "SQL_Latin1_General_CP1_CI_AS",
                "autoPauseDelay": 60,
                "minCapacity": 1,
                "readScale": "Disabled",
                "zoneRedundant": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', parameters('serverName'))]"
              ]
            }
          ],
          "outputs": {
            "sqlDbOutput": {
              "type": "object",
              "value": {
                "sqlServerName": "[format('{0}.database.windows.net', parameters('serverName'))]",
                "sqlDbName": "[parameters('sqlDBName')]",
                "sqlDbUser": "[parameters('administratorLogin')]",
                "sqlDbPwd": "[parameters('administratorLoginPassword')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_managed_identity')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy_azure_ai_service",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionPrefix')]"
          },
          "solutionLocation": {
            "value": "[variables('solutionLocation')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "6442702850625863598"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string"
            },
            "accounts_byc_cogser_name": {
              "type": "string",
              "defaultValue": "[format('{0}-cogser', parameters('solutionName'))]"
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2023-05-01",
              "name": "[parameters('accounts_byc_cogser_name')]",
              "location": "[parameters('solutionLocation')]",
              "sku": {
                "name": "S0"
              },
              "kind": "CognitiveServices",
              "identity": {
                "type": "None"
              },
              "properties": {
                "apiProperties": {},
                "customSubDomainName": "[parameters('accounts_byc_cogser_name')]",
                "networkAcls": {
                  "defaultAction": "Allow",
                  "virtualNetworkRules": [],
                  "ipRules": []
                },
                "publicNetworkAccess": "Enabled"
              }
            }
          ],
          "outputs": {
            "cogSearchOutput": {
              "type": "object",
              "value": {
                "cogServiceName": "[parameters('accounts_byc_cogser_name')]",
                "cogServiceKey": "[listKeys(resourceId('Microsoft.CognitiveServices/accounts', parameters('accounts_byc_cogser_name')), '2023-05-01').key1]",
                "cogServiceEndpoint": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('accounts_byc_cogser_name')), '2023-05-01').endpoint]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy_ai_search_service",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionPrefix')]"
          },
          "solutionLocation": {
            "value": "[variables('solutionLocation')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "11306929187483586125"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string"
            },
            "searchServices_byc_cs_name": {
              "type": "string",
              "defaultValue": "[format('{0}-cs', parameters('solutionName'))]"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Search/searchServices",
              "apiVersion": "2023-11-01",
              "name": "[parameters('searchServices_byc_cs_name')]",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "ProjectType": "aoai-your-data-service"
              },
              "sku": {
                "name": "basic"
              },
              "properties": {
                "replicaCount": 1,
                "partitionCount": 1,
                "hostingMode": "default",
                "publicNetworkAccess": "enabled",
                "networkRuleSet": {
                  "ipRules": []
                },
                "encryptionWithCmk": {
                  "enforcement": "Unspecified"
                },
                "disableLocalAuth": false,
                "authOptions": {
                  "apiKeyOnly": {}
                },
                "semanticSearch": "free"
              }
            }
          ],
          "outputs": {
            "searchServiceOutput": {
              "type": "object",
              "value": {
                "searchServiceName": "[parameters('searchServices_byc_cs_name')]",
                "searchServiceAdminKey": "[listAdminKeys(resourceId('Microsoft.Search/searchServices', parameters('searchServices_byc_cs_name')), '2023-11-01').primaryKey]",
                "searchServiceEndpoint": "[format('https://{0}.search.windows.net', parameters('searchServices_byc_cs_name'))]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy_azure_open_ai",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionPrefix')]"
          },
          "solutionLocation": {
            "value": "[variables('resourceGroupLocation')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "4946753000029951086"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string"
            },
            "accounts_byc_openai_name": {
              "type": "string",
              "defaultValue": "[format('{0}-openai', parameters('solutionName'))]"
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2023-05-01",
              "name": "[parameters('accounts_byc_openai_name')]",
              "location": "[parameters('solutionLocation')]",
              "sku": {
                "name": "S0"
              },
              "kind": "OpenAI",
              "properties": {
                "customSubDomainName": "[parameters('accounts_byc_openai_name')]",
                "networkAcls": {
                  "defaultAction": "Allow",
                  "virtualNetworkRules": [],
                  "ipRules": []
                },
                "publicNetworkAccess": "Enabled"
              }
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('accounts_byc_openai_name'), 'gpt-4')]",
              "sku": {
                "name": "Standard",
                "capacity": 10
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "gpt-4",
                  "version": "0125-Preview"
                },
                "versionUpgradeOption": "OnceCurrentVersionExpired",
                "raiPolicyName": "Microsoft.Default"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('accounts_byc_openai_name'))]"
              ]
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('accounts_byc_openai_name'), 'text-embedding-ada-002')]",
              "sku": {
                "name": "Standard",
                "capacity": 45
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "text-embedding-ada-002",
                  "version": "2"
                },
                "versionUpgradeOption": "OnceNewDefaultVersionAvailable",
                "raiPolicyName": "Microsoft.Default"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts/deployments', parameters('accounts_byc_openai_name'), 'gpt-4')]",
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('accounts_byc_openai_name'))]"
              ]
            }
          ],
          "outputs": {
            "openAIOutput": {
              "type": "object",
              "value": {
                "openAPIKey": "[listKeys(resourceId('Microsoft.CognitiveServices/accounts', parameters('accounts_byc_openai_name')), '2023-05-01').key1]",
                "openAPIVersion": "2023-05-01",
                "openAPIEndpoint": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('accounts_byc_openai_name')), '2023-05-01').endpoint]",
                "openAIAccountName": "[parameters('accounts_byc_openai_name')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy_upload_files_script",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_storage_account'), '2022-09-01').outputs.storageAccountOutput.value.name]"
          },
          "solutionLocation": {
            "value": "[variables('solutionLocation')]"
          },
          "containerName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_storage_account'), '2022-09-01').outputs.storageAccountOutput.value.dataContainer]"
          },
          "identity": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_managed_identity'), '2022-09-01').outputs.managedIdentityOutput.value.id]"
          },
          "baseUrl": {
            "value": "[variables('baseUrl')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "12194037622634235951"
            }
          },
          "parameters": {
            "solutionLocation": {
              "type": "string",
              "metadata": {
                "description": "Specifies the location for resources."
              }
            },
            "storageAccountName": {
              "type": "string"
            },
            "containerName": {
              "type": "string"
            },
            "identity": {
              "type": "string"
            },
            "baseUrl": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2020-10-01",
              "name": "copy_demo_Data",
              "kind": "AzureCLI",
              "location": "[parameters('solutionLocation')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('identity'))]": {}
                }
              },
              "properties": {
                "azCliVersion": "2.50.0",
                "primaryScriptUri": "[format('{0}Deployment/scripts/copy_kb_files.sh', parameters('baseUrl'))]",
                "arguments": "[format('{0} {1} {2}', parameters('storageAccountName'), parameters('containerName'), parameters('baseUrl'))]",
                "timeout": "PT1H",
                "retentionInterval": "PT1H",
                "cleanupPreference": "OnSuccess"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_managed_identity')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_storage_account')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy_azure_function",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionPrefix')]"
          },
          "solutionLocation": {
            "value": "[variables('solutionLocation')]"
          },
          "azureOpenAIApiKey": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_azure_open_ai'), '2022-09-01').outputs.openAIOutput.value.openAPIKey]"
          },
          "azureOpenAIApiVersion": {
            "value": "2024-02-15-preview"
          },
          "azureOpenAIEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_azure_open_ai'), '2022-09-01').outputs.openAIOutput.value.openAPIEndpoint]"
          },
          "azureSearchAdminKey": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_ai_search_service'), '2022-09-01').outputs.searchServiceOutput.value.searchServiceAdminKey]"
          },
          "azureSearchServiceEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_ai_search_service'), '2022-09-01').outputs.searchServiceOutput.value.searchServiceEndpoint]"
          },
          "azureSearchIndex": {
            "value": "transcripts_index"
          },
          "sqlServerName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_sql_db'), '2022-09-01').outputs.sqlDbOutput.value.sqlServerName]"
          },
          "sqlDbName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_sql_db'), '2022-09-01').outputs.sqlDbOutput.value.sqlDbName]"
          },
          "sqlDbUser": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_sql_db'), '2022-09-01').outputs.sqlDbOutput.value.sqlDbUser]"
          },
          "sqlDbPwd": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_sql_db'), '2022-09-01').outputs.sqlDbOutput.value.sqlDbPwd]"
          },
          "functionAppVersion": {
            "value": "[variables('appversion')]"
          },
          "sqlSystemPrompt": {
            "value": "[variables('functionAppSqlPrompt')]"
          },
          "callTranscriptSystemPrompt": {
            "value": "[variables('functionAppCallTranscriptSystemPrompt')]"
          },
          "streamTextSystemPrompt": {
            "value": "[variables('functionAppStreamTextSystemPrompt')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "1024802476913421252"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "metadata": {
                "description": "Specifies the location for resources."
              }
            },
            "solutionLocation": {
              "type": "string"
            },
            "azureOpenAIApiKey": {
              "type": "securestring"
            },
            "azureOpenAIApiVersion": {
              "type": "string"
            },
            "azureOpenAIEndpoint": {
              "type": "string"
            },
            "azureSearchAdminKey": {
              "type": "securestring"
            },
            "azureSearchServiceEndpoint": {
              "type": "string"
            },
            "azureSearchIndex": {
              "type": "string"
            },
            "sqlServerName": {
              "type": "string"
            },
            "sqlDbName": {
              "type": "string"
            },
            "sqlDbUser": {
              "type": "string"
            },
            "sqlDbPwd": {
              "type": "securestring"
            },
            "functionAppVersion": {
              "type": "string"
            },
            "sqlSystemPrompt": {
              "type": "string",
              "metadata": {
                "description": "Azure Function App SQL System Prompt"
              }
            },
            "callTranscriptSystemPrompt": {
              "type": "string",
              "metadata": {
                "description": "Azure Function App CallTranscript System Prompt"
              }
            },
            "streamTextSystemPrompt": {
              "type": "string",
              "metadata": {
                "description": "Azure Function App Stream Text System Prompt"
              }
            }
          },
          "variables": {
            "functionAppName": "[format('{0}fn', parameters('solutionName'))]",
            "azureOpenAIDeploymentModel": "gpt-4",
            "azureOpenAIEmbeddingDeployment": "text-embedding-ada-002",
            "valueOne": "1"
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}fnstorage', parameters('solutionName'))]",
              "location": "[parameters('solutionLocation')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "allowSharedKeyAccess": false
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[format('workspace-{0}', parameters('solutionName'))]",
              "location": "[parameters('solutionLocation')]"
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[variables('functionAppName')]",
              "location": "[parameters('solutionLocation')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', format('workspace-{0}', parameters('solutionName')))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', format('workspace-{0}', parameters('solutionName')))]"
              ]
            },
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2022-06-01-preview",
              "name": "[format('{0}env', parameters('solutionName'))]",
              "location": "[parameters('solutionLocation')]",
              "sku": {
                "name": "Consumption"
              },
              "properties": {
                "appLogsConfiguration": {
                  "destination": "log-analytics",
                  "logAnalyticsConfiguration": {
                    "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', format('workspace-{0}', parameters('solutionName'))), '2022-10-01').customerId]",
                    "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', format('workspace-{0}', parameters('solutionName'))), '2022-10-01').primarySharedKey]"
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', format('workspace-{0}', parameters('solutionName')))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2024-04-01",
              "name": "[variables('functionAppName')]",
              "location": "[parameters('solutionLocation')]",
              "kind": "functionapp",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', format('{0}env', parameters('solutionName')))]",
                "siteConfig": {
                  "linuxFxVersion": "[format('DOCKER|bycwacontainerreg.azurecr.io/byc-wa-fn:{0}', parameters('functionAppVersion'))]",
                  "appSettings": [
                    {
                      "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                      "value": "[reference(resourceId('Microsoft.Insights/components', variables('functionAppName')), '2015-05-01').InstrumentationKey]"
                    },
                    {
                      "name": "AZURE_OPEN_AI_API_KEY",
                      "value": "[parameters('azureOpenAIApiKey')]"
                    },
                    {
                      "name": "AZURE_OPEN_AI_DEPLOYMENT_MODEL",
                      "value": "[variables('azureOpenAIDeploymentModel')]"
                    },
                    {
                      "name": "AZURE_OPEN_AI_ENDPOINT",
                      "value": "[parameters('azureOpenAIEndpoint')]"
                    },
                    {
                      "name": "AZURE_OPENAI_EMBEDDING_DEPLOYMENT",
                      "value": "[variables('azureOpenAIEmbeddingDeployment')]"
                    },
                    {
                      "name": "OPENAI_API_VERSION",
                      "value": "[parameters('azureOpenAIApiVersion')]"
                    },
                    {
                      "name": "AZURE_AI_SEARCH_API_KEY",
                      "value": "[parameters('azureSearchAdminKey')]"
                    },
                    {
                      "name": "AZURE_AI_SEARCH_ENDPOINT",
                      "value": "[parameters('azureSearchServiceEndpoint')]"
                    },
                    {
                      "name": "AZURE_SEARCH_INDEX",
                      "value": "[parameters('azureSearchIndex')]"
                    },
                    {
                      "name": "PYTHON_ENABLE_INIT_INDEXING",
                      "value": "[variables('valueOne')]"
                    },
                    {
                      "name": "PYTHON_ISOLATE_WORKER_DEPENDENCIES",
                      "value": "[variables('valueOne')]"
                    },
                    {
                      "name": "SQLDB_CONNECTION_STRING",
                      "value": "TBD"
                    },
                    {
                      "name": "SQLDB_SERVER",
                      "value": "[parameters('sqlServerName')]"
                    },
                    {
                      "name": "SQLDB_DATABASE",
                      "value": "[parameters('sqlDbName')]"
                    },
                    {
                      "name": "SQLDB_USERNAME",
                      "value": "[parameters('sqlDbUser')]"
                    },
                    {
                      "name": "SQLDB_PASSWORD",
                      "value": "[parameters('sqlDbPwd')]"
                    },
                    {
                      "name": "AZURE_SQL_SYSTEM_PROMPT",
                      "value": "[parameters('sqlSystemPrompt')]"
                    },
                    {
                      "name": "AZURE_CALL_TRANSCRIPT_SYSTEM_PROMPT",
                      "value": "[parameters('callTranscriptSystemPrompt')]"
                    },
                    {
                      "name": "AZURE_OPENAI_STREAM_TEXT_SYSTEM_PROMPT",
                      "value": "[parameters('streamTextSystemPrompt')]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/components', variables('functionAppName'))]",
                "[resourceId('Microsoft.App/managedEnvironments', format('{0}env', parameters('solutionName')))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy_azure_open_ai')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy_ai_search_service')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_sql_db')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_storage_account')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy_azure_function_script_url",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionPrefix')]"
          },
          "identity": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_managed_identity'), '2022-09-01').outputs.managedIdentityOutput.value.id]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "4083258100998880594"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "metadata": {
                "description": "Specifies the location for resources."
              }
            },
            "identity": {
              "type": "string"
            }
          },
          "variables": {
            "functionAppName": "[format('{0}fn', parameters('solutionName'))]",
            "functionName": "stream_openai_text"
          },
          "resources": [],
          "outputs": {
            "functionAppUrl": {
              "type": "string",
              "value": "[format('https://{0}/api/{1}', reference(resourceId('Microsoft.Web/sites', variables('functionAppName')), '2021-02-01').defaultHostName, variables('functionName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy_azure_function')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_managed_identity')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy_keyvault",
      "resourceGroup": "[resourceGroup().name]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionPrefix')]"
          },
          "solutionLocation": {
            "value": "[variables('solutionLocation')]"
          },
          "objectId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_managed_identity'), '2022-09-01').outputs.managedIdentityOutput.value.objectId]"
          },
          "tenantId": {
            "value": "[subscription().tenantId]"
          },
          "managedIdentityObjectId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_managed_identity'), '2022-09-01').outputs.managedIdentityOutput.value.objectId]"
          },
          "adlsAccountName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_storage_account'), '2022-09-01').outputs.storageAccountOutput.value.storageAccountName]"
          },
          "azureOpenAIApiKey": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_azure_open_ai'), '2022-09-01').outputs.openAIOutput.value.openAPIKey]"
          },
          "azureOpenAIApiVersion": {
            "value": "2024-02-15-preview"
          },
          "azureOpenAIEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_azure_open_ai'), '2022-09-01').outputs.openAIOutput.value.openAPIEndpoint]"
          },
          "azureSearchAdminKey": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_ai_search_service'), '2022-09-01').outputs.searchServiceOutput.value.searchServiceAdminKey]"
          },
          "azureSearchServiceEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_ai_search_service'), '2022-09-01').outputs.searchServiceOutput.value.searchServiceEndpoint]"
          },
          "azureSearchServiceName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_ai_search_service'), '2022-09-01').outputs.searchServiceOutput.value.searchServiceName]"
          },
          "azureSearchIndex": {
            "value": "transcripts_index"
          },
          "cogServiceEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_azure_ai_service'), '2022-09-01').outputs.cogSearchOutput.value.cogServiceEndpoint]"
          },
          "cogServiceName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_azure_ai_service'), '2022-09-01').outputs.cogSearchOutput.value.cogServiceName]"
          },
          "cogServiceKey": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_azure_ai_service'), '2022-09-01').outputs.cogSearchOutput.value.cogServiceKey]"
          },
          "sqlServerName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_sql_db'), '2022-09-01').outputs.sqlDbOutput.value.sqlServerName]"
          },
          "sqlDbName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_sql_db'), '2022-09-01').outputs.sqlDbOutput.value.sqlDbName]"
          },
          "sqlDbUser": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_sql_db'), '2022-09-01').outputs.sqlDbOutput.value.sqlDbUser]"
          },
          "sqlDbPwd": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_sql_db'), '2022-09-01').outputs.sqlDbOutput.value.sqlDbPwd]"
          },
          "enableSoftDelete": {
            "value": false
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "8095998428893462676"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "solutionLocation": {
              "type": "string",
              "metadata": {
                "description": "Solution Location"
              }
            },
            "utc": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            },
            "kvName": {
              "type": "string",
              "defaultValue": "[format('{0}-kv-{1}', parameters('solutionName'), uniqueString(parameters('utc')))]",
              "metadata": {
                "description": "Name"
              }
            },
            "objectId": {
              "type": "string",
              "metadata": {
                "description": "Object Id. The object ID of a user, service principal or security group in the Azure Active Directory tenant for the vault."
              }
            },
            "createMode": {
              "type": "string",
              "defaultValue": "default",
              "metadata": {
                "description": "Create Mode"
              }
            },
            "enableForDeployment": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enabled For Deployment. Property to specify whether Azure Virtual Machines are permitted to retrieve certificates stored as secrets from the key vault."
              }
            },
            "enableForDiskEncryption": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enabled For Disk Encryption. Property to specify whether Azure Disk Encryption is permitted to retrieve secrets from the vault and unwrap keys."
              }
            },
            "enableForTemplateDeployment": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enabled For Template Deployment. Property to specify whether Azure Resource Manager is permitted to retrieve secrets from the key vault."
              }
            },
            "enableRBACAuthorization": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable RBAC Authorization. Property that controls how data actions are authorized."
              }
            },
            "enableSoftDelete": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable Soft Delete. Property to specify whether the \"soft delete\" functionality is enabled for this key vault."
              }
            },
            "softDeleteRetentionInDays": {
              "type": "int",
              "defaultValue": 30,
              "metadata": {
                "description": "Soft Delete Retention in Days. softDelete data retention days. It accepts >=7 and <=90."
              }
            },
            "publicNetworkAccess": {
              "type": "string",
              "defaultValue": "enabled",
              "allowedValues": [
                "enabled",
                "disabled"
              ],
              "metadata": {
                "description": "Public Network Access, Property to specify whether the vault will accept traffic from public internet."
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "standard",
              "allowedValues": [
                "standard",
                "premium"
              ],
              "metadata": {
                "description": "SKU"
              }
            },
            "tenantId": {
              "type": "string",
              "metadata": {
                "description": "Tenant Id"
              }
            },
            "managedIdentityObjectId": {
              "type": "string"
            },
            "adlsAccountName": {
              "type": "string"
            },
            "azureOpenAIApiKey": {
              "type": "securestring"
            },
            "azureOpenAIApiVersion": {
              "type": "string"
            },
            "azureOpenAIEndpoint": {
              "type": "string"
            },
            "azureSearchAdminKey": {
              "type": "securestring"
            },
            "azureSearchServiceEndpoint": {
              "type": "string"
            },
            "azureSearchServiceName": {
              "type": "string"
            },
            "azureSearchIndex": {
              "type": "string"
            },
            "cogServiceEndpoint": {
              "type": "string"
            },
            "cogServiceKey": {
              "type": "securestring"
            },
            "cogServiceName": {
              "type": "string"
            },
            "sqlServerName": {
              "type": "string"
            },
            "sqlDbName": {
              "type": "string"
            },
            "sqlDbUser": {
              "type": "string"
            },
            "sqlDbPwd": {
              "type": "securestring"
            }
          },
          "variables": {
            "vaultUri": "[format('https://{0}.vault.azure.net/', parameters('kvName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2022-07-01",
              "name": "[parameters('kvName')]",
              "location": "[parameters('solutionLocation')]",
              "tags": {
                "app": "[parameters('solutionName')]",
                "location": "[parameters('solutionLocation')]"
              },
              "properties": {
                "accessPolicies": [
                  {
                    "objectId": "[parameters('objectId')]",
                    "permissions": {
                      "certificates": [
                        "all"
                      ],
                      "keys": [
                        "all"
                      ],
                      "secrets": [
                        "all"
                      ],
                      "storage": [
                        "all"
                      ]
                    },
                    "tenantId": "[parameters('tenantId')]"
                  }
                ],
                "createMode": "[parameters('createMode')]",
                "enabledForDeployment": "[parameters('enableForDeployment')]",
                "enabledForDiskEncryption": "[parameters('enableForDiskEncryption')]",
                "enabledForTemplateDeployment": "[parameters('enableForTemplateDeployment')]",
                "enableRbacAuthorization": "[parameters('enableRBACAuthorization')]",
                "enableSoftDelete": "[parameters('enableSoftDelete')]",
                "softDeleteRetentionInDays": "[parameters('softDeleteRetentionInDays')]",
                "provisioningState": "RegisteringDns",
                "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                "sku": {
                  "family": "A",
                  "name": "[parameters('sku')]"
                },
                "tenantId": "[parameters('tenantId')]",
                "vaultUri": "[variables('vaultUri')]"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(resourceGroup().id, parameters('managedIdentityObjectId'), resourceId('Microsoft.Authorization/roleDefinitions', '00482a5a-887f-4fb3-b363-3b7fe8e74483'))]",
              "properties": {
                "principalId": "[parameters('managedIdentityObjectId')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '00482a5a-887f-4fb3-b363-3b7fe8e74483')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('kvName'), 'TENANT-ID')]",
              "properties": {
                "value": "[parameters('tenantId')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('kvName'), 'ADLS-ACCOUNT-NAME')]",
              "properties": {
                "value": "[parameters('adlsAccountName')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('kvName'), 'AZURE-OPENAI-KEY')]",
              "properties": {
                "value": "[parameters('azureOpenAIApiKey')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('kvName'), 'AZURE-OPENAI-PREVIEW-API-VERSION')]",
              "properties": {
                "value": "[parameters('azureOpenAIApiVersion')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('kvName'), 'AZURE-OPENAI-ENDPOINT')]",
              "properties": {
                "value": "[parameters('azureOpenAIEndpoint')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('kvName'), 'AZURE-SEARCH-KEY')]",
              "properties": {
                "value": "[parameters('azureSearchAdminKey')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('kvName'), 'AZURE-SEARCH-ENDPOINT')]",
              "properties": {
                "value": "[parameters('azureSearchServiceEndpoint')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('kvName'), 'AZURE-SEARCH-SERVICE')]",
              "properties": {
                "value": "[parameters('azureSearchServiceName')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('kvName'), 'AZURE-SEARCH-INDEX')]",
              "properties": {
                "value": "[parameters('azureSearchIndex')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('kvName'), 'COG-SERVICES-ENDPOINT')]",
              "properties": {
                "value": "[parameters('cogServiceEndpoint')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('kvName'), 'COG-SERVICES-KEY')]",
              "properties": {
                "value": "[parameters('cogServiceKey')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('kvName'), 'COG-SERVICES-NAME')]",
              "properties": {
                "value": "[parameters('cogServiceName')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('kvName'), 'AZURE-SUBSCRIPTION-ID')]",
              "properties": {
                "value": "[subscription().subscriptionId]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('kvName'), 'AZURE-RESOURCE-GROUP')]",
              "properties": {
                "value": "[resourceGroup().name]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('kvName'), 'AZURE-LOCATION')]",
              "properties": {
                "value": "[parameters('solutionLocation')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('kvName'), 'SQLDB-SERVER')]",
              "properties": {
                "value": "[parameters('sqlServerName')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('kvName'), 'SQLDB-DATABASE')]",
              "properties": {
                "value": "[parameters('sqlDbName')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('kvName'), 'SQLDB-USERNAME')]",
              "properties": {
                "value": "[parameters('sqlDbUser')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-11-01-preview",
              "name": "[format('{0}/{1}', parameters('kvName'), 'SQLDB-PASSWORD')]",
              "properties": {
                "value": "[parameters('sqlDbPwd')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
              ]
            }
          ],
          "outputs": {
            "keyvaultOutput": {
              "type": "object",
              "value": {
                "id": "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]",
                "name": "[parameters('kvName')]",
                "uri": "[variables('vaultUri')]",
                "resource": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('kvName')), '2022-07-01', 'full')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy_azure_ai_service')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy_azure_open_ai')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy_ai_search_service')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_managed_identity')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_sql_db')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_storage_account')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy_index_scripts",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionLocation": {
            "value": "[variables('solutionLocation')]"
          },
          "identity": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_managed_identity'), '2022-09-01').outputs.managedIdentityOutput.value.id]"
          },
          "baseUrl": {
            "value": "[variables('baseUrl')]"
          },
          "keyVaultName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_keyvault'), '2022-09-01').outputs.keyvaultOutput.value.name]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "3483044528146968359"
            }
          },
          "parameters": {
            "solutionLocation": {
              "type": "string",
              "metadata": {
                "description": "Specifies the location for resources."
              }
            },
            "baseUrl": {
              "type": "string"
            },
            "keyVaultName": {
              "type": "string"
            },
            "identity": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2020-10-01",
              "name": "create_search_indexes",
              "kind": "AzureCLI",
              "location": "[parameters('solutionLocation')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('identity'))]": {}
                }
              },
              "properties": {
                "azCliVersion": "2.52.0",
                "primaryScriptUri": "[format('{0}Deployment/scripts/run_create_index_scripts.sh', parameters('baseUrl'))]",
                "arguments": "[format('{0} {1}', parameters('baseUrl'), parameters('keyVaultName'))]",
                "timeout": "PT1H",
                "retentionInterval": "PT1H",
                "cleanupPreference": "OnSuccess"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_keyvault')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_managed_identity')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy_app_service",
      "resourceGroup": "[resourceGroup().name]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "solutionName": {
            "value": "[parameters('solutionPrefix')]"
          },
          "AzureSearchService": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_ai_search_service'), '2022-09-01').outputs.searchServiceOutput.value.searchServiceName]"
          },
          "AzureSearchIndex": {
            "value": "transcripts_index"
          },
          "AzureSearchKey": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_ai_search_service'), '2022-09-01').outputs.searchServiceOutput.value.searchServiceAdminKey]"
          },
          "AzureSearchUseSemanticSearch": {
            "value": "True"
          },
          "AzureSearchSemanticSearchConfig": {
            "value": "my-semantic-config"
          },
          "AzureSearchIndexIsPrechunked": {
            "value": "False"
          },
          "AzureSearchTopK": {
            "value": "5"
          },
          "AzureSearchContentColumns": {
            "value": "content"
          },
          "AzureSearchFilenameColumn": {
            "value": "chunk_id"
          },
          "AzureSearchTitleColumn": {
            "value": "client_id"
          },
          "AzureSearchUrlColumn": {
            "value": "sourceurl"
          },
          "AzureOpenAIResource": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_azure_open_ai'), '2022-09-01').outputs.openAIOutput.value.openAPIEndpoint]"
          },
          "AzureOpenAIEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_azure_open_ai'), '2022-09-01').outputs.openAIOutput.value.openAPIEndpoint]"
          },
          "AzureOpenAIModel": {
            "value": "gpt-4"
          },
          "AzureOpenAIKey": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_azure_open_ai'), '2022-09-01').outputs.openAIOutput.value.openAPIKey]"
          },
          "AzureOpenAIModelName": {
            "value": "gpt-4"
          },
          "AzureOpenAITemperature": {
            "value": "0"
          },
          "AzureOpenAITopP": {
            "value": "1"
          },
          "AzureOpenAIMaxTokens": {
            "value": "1000"
          },
          "AzureOpenAIStopSequence": {
            "value": ""
          },
          "AzureOpenAISystemMessage": {
            "value": "You are a helpful Wealth Advisor assistant"
          },
          "AzureOpenAIApiVersion": {
            "value": "2024-02-15-preview"
          },
          "AzureOpenAIStream": {
            "value": "True"
          },
          "AzureSearchQueryType": {
            "value": "simple"
          },
          "AzureSearchVectorFields": {
            "value": "contentVector"
          },
          "AzureSearchPermittedGroupsField": {
            "value": ""
          },
          "AzureSearchStrictness": {
            "value": "3"
          },
          "AzureOpenAIEmbeddingName": {
            "value": "text-embedding-ada-002"
          },
          "AzureOpenAIEmbeddingkey": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_azure_open_ai'), '2022-09-01').outputs.openAIOutput.value.openAPIKey]"
          },
          "AzureOpenAIEmbeddingEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_azure_open_ai'), '2022-09-01').outputs.openAIOutput.value.openAPIEndpoint]"
          },
          "USE_AZUREFUNCTION": {
            "value": "True"
          },
          "STREAMING_AZUREFUNCTION_ENDPOINT": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy_azure_function_script_url'), '2022-09-01').outputs.functionAppUrl.value]"
          },
          "SQLDB_SERVER": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_sql_db'), '2022-09-01').outputs.sqlDbOutput.value.sqlServerName]"
          },
          "SQLDB_DATABASE": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_sql_db'), '2022-09-01').outputs.sqlDbOutput.value.sqlDbName]"
          },
          "SQLDB_USERNAME": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_sql_db'), '2022-09-01').outputs.sqlDbOutput.value.sqlDbUser]"
          },
          "SQLDB_PASSWORD": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_sql_db'), '2022-09-01').outputs.sqlDbOutput.value.sqlDbPwd]"
          },
          "AZURE_COSMOSDB_ACCOUNT": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_cosmos_db'), '2022-09-01').outputs.cosmosOutput.value.cosmosAccountName]"
          },
          "AZURE_COSMOSDB_CONVERSATIONS_CONTAINER": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_cosmos_db'), '2022-09-01').outputs.cosmosOutput.value.cosmosContainerName]"
          },
          "AZURE_COSMOSDB_DATABASE": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_cosmos_db'), '2022-09-01').outputs.cosmosOutput.value.cosmosDatabaseName]"
          },
          "AZURE_COSMOSDB_ENABLE_FEEDBACK": {
            "value": "True"
          },
          "VITE_POWERBI_EMBED_URL": {
            "value": "TBD"
          },
          "Appversion": {
            "value": "[variables('appversion')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "11910107516831069075"
            }
          },
          "parameters": {
            "solutionName": {
              "type": "string",
              "minLength": 3,
              "maxLength": 15,
              "metadata": {
                "description": "Solution Name"
              }
            },
            "HostingPlanName": {
              "type": "string",
              "defaultValue": "[format('{0}-app-service-plan', parameters('solutionName'))]",
              "metadata": {
                "description": "Name of App Service plan"
              }
            },
            "HostingPlanSku": {
              "type": "string",
              "defaultValue": "P0v3",
              "allowedValues": [
                "F1",
                "D1",
                "B1",
                "B2",
                "B3",
                "S1",
                "S2",
                "S3",
                "P1",
                "P2",
                "P3",
                "P4",
                "P0v3"
              ],
              "metadata": {
                "description": "The pricing tier for the App Service plan"
              }
            },
            "WebsiteName": {
              "type": "string",
              "defaultValue": "[format('{0}-app-service', parameters('solutionName'))]",
              "metadata": {
                "description": "Name of Web App"
              }
            },
            "ApplicationInsightsName": {
              "type": "string",
              "defaultValue": "[format('{0}-app-insights', parameters('solutionName'))]",
              "metadata": {
                "description": "Name of Application Insights"
              }
            },
            "AzureSearchService": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Name of Azure Search Service"
              }
            },
            "AzureSearchIndex": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Name of Azure Search Index"
              }
            },
            "AzureSearchKey": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "Azure Search Admin Key"
              }
            },
            "AzureSearchUseSemanticSearch": {
              "type": "string",
              "defaultValue": "False",
              "metadata": {
                "description": "Use semantic search"
              }
            },
            "AzureSearchSemanticSearchConfig": {
              "type": "string",
              "defaultValue": "default",
              "metadata": {
                "description": "Semantic search config"
              }
            },
            "AzureSearchIndexIsPrechunked": {
              "type": "string",
              "defaultValue": "False",
              "metadata": {
                "description": "Is the index prechunked"
              }
            },
            "AzureSearchTopK": {
              "type": "string",
              "defaultValue": "5",
              "metadata": {
                "description": "Top K results"
              }
            },
            "AzureSearchEnableInDomain": {
              "type": "string",
              "defaultValue": "False",
              "metadata": {
                "description": "Enable in domain"
              }
            },
            "AzureSearchContentColumns": {
              "type": "string",
              "defaultValue": "content",
              "metadata": {
                "description": "Content columns"
              }
            },
            "AzureSearchFilenameColumn": {
              "type": "string",
              "defaultValue": "filename",
              "metadata": {
                "description": "Filename column"
              }
            },
            "AzureSearchTitleColumn": {
              "type": "string",
              "defaultValue": "client_id",
              "metadata": {
                "description": "Title column"
              }
            },
            "AzureSearchUrlColumn": {
              "type": "string",
              "defaultValue": "sourceurl",
              "metadata": {
                "description": "Url column"
              }
            },
            "AzureOpenAIResource": {
              "type": "string",
              "metadata": {
                "description": "Name of Azure OpenAI Resource"
              }
            },
            "AzureOpenAIModel": {
              "type": "string",
              "metadata": {
                "description": "Azure OpenAI Model Deployment Name"
              }
            },
            "AzureOpenAIModelName": {
              "type": "string",
              "defaultValue": "gpt-4",
              "metadata": {
                "description": "Azure OpenAI Model Name"
              }
            },
            "AzureOpenAIEndpoint": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure Open AI Endpoint"
              }
            },
            "AzureOpenAIKey": {
              "type": "securestring",
              "metadata": {
                "description": "Azure OpenAI Key"
              }
            },
            "AzureOpenAITemperature": {
              "type": "string",
              "defaultValue": "0",
              "metadata": {
                "description": "Azure OpenAI Temperature"
              }
            },
            "AzureOpenAITopP": {
              "type": "string",
              "defaultValue": "1",
              "metadata": {
                "description": "Azure OpenAI Top P"
              }
            },
            "AzureOpenAIMaxTokens": {
              "type": "string",
              "defaultValue": "1000",
              "metadata": {
                "description": "Azure OpenAI Max Tokens"
              }
            },
            "AzureOpenAIStopSequence": {
              "type": "string",
              "defaultValue": "\n",
              "metadata": {
                "description": "Azure OpenAI Stop Sequence"
              }
            },
            "AzureOpenAISystemMessage": {
              "type": "string",
              "defaultValue": "You are an AI assistant that helps people find information.",
              "metadata": {
                "description": "Azure OpenAI System Message"
              }
            },
            "AzureOpenAIApiVersion": {
              "type": "string",
              "defaultValue": "2024-02-15-preview",
              "metadata": {
                "description": "Azure OpenAI Api Version"
              }
            },
            "AzureOpenAIStream": {
              "type": "string",
              "defaultValue": "True",
              "metadata": {
                "description": "Whether or not to stream responses from Azure OpenAI"
              }
            },
            "AzureSearchQueryType": {
              "type": "string",
              "defaultValue": "simple",
              "allowedValues": [
                "simple",
                "semantic",
                "vector",
                "vectorSimpleHybrid",
                "vectorSemanticHybrid"
              ],
              "metadata": {
                "description": "Azure Search Query Type"
              }
            },
            "AzureSearchVectorFields": {
              "type": "string",
              "defaultValue": "contentVector",
              "metadata": {
                "description": "Azure Search Vector Fields"
              }
            },
            "AzureSearchPermittedGroupsField": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure Search Permitted Groups Field"
              }
            },
            "AzureSearchStrictness": {
              "type": "string",
              "defaultValue": "3",
              "allowedValues": [
                "1",
                "2",
                "3",
                "4",
                "5"
              ],
              "metadata": {
                "description": "Azure Search Strictness"
              }
            },
            "AzureOpenAIEmbeddingName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure OpenAI Embedding Deployment Name"
              }
            },
            "AzureOpenAIEmbeddingkey": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure Open AI Embedding Key"
              }
            },
            "AzureOpenAIEmbeddingEndpoint": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure Open AI Embedding Endpoint"
              }
            },
            "WebAppEnableChatHistory": {
              "type": "string",
              "defaultValue": "False",
              "metadata": {
                "description": "Enable chat history by deploying a Cosmos DB instance"
              }
            },
            "USE_AZUREFUNCTION": {
              "type": "string",
              "defaultValue": "True",
              "metadata": {
                "description": "Use Azure Function"
              }
            },
            "STREAMING_AZUREFUNCTION_ENDPOINT": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure Function Endpoint"
              }
            },
            "SQLDB_SERVER": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "SQL Database Server Name"
              }
            },
            "SQLDB_DATABASE": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "SQL Database Name"
              }
            },
            "SQLDB_USERNAME": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "SQL Database Username"
              }
            },
            "SQLDB_PASSWORD": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "SQL Database Password"
              }
            },
            "AZURE_COSMOSDB_ACCOUNT": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure Cosmos DB Account"
              }
            },
            "AZURE_COSMOSDB_ACCOUNT_KEY": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "Azure Cosmos DB Account Key"
              }
            },
            "AZURE_COSMOSDB_CONVERSATIONS_CONTAINER": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure Cosmos DB Conversations Container"
              }
            },
            "AZURE_COSMOSDB_DATABASE": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure Cosmos DB Database"
              }
            },
            "AZURE_COSMOSDB_ENABLE_FEEDBACK": {
              "type": "string",
              "defaultValue": "True",
              "metadata": {
                "description": "Enable feedback in Cosmos DB"
              }
            },
            "VITE_POWERBI_EMBED_URL": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Power BI Embed URL"
              }
            },
            "Appversion": {
              "type": "string"
            }
          },
          "variables": {
            "WebAppImageName": "[format('DOCKER|bycwacontainerreg.azurecr.io/byc-wa-app:{0}', parameters('Appversion'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2020-06-01",
              "name": "[parameters('HostingPlanName')]",
              "location": "[resourceGroup().location]",
              "sku": {
                "name": "[parameters('HostingPlanSku')]"
              },
              "properties": {
                "name": "[parameters('HostingPlanName')]",
                "reserved": true
              },
              "kind": "linux"
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2020-06-01",
              "name": "[parameters('WebsiteName')]",
              "location": "[resourceGroup().location]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[parameters('HostingPlanName')]",
                "siteConfig": {
                  "appSettings": [
                    {
                      "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                      "value": "[reference(resourceId('Microsoft.Insights/components', parameters('ApplicationInsightsName')), '2015-05-01').InstrumentationKey]"
                    },
                    {
                      "name": "AZURE_SEARCH_SERVICE",
                      "value": "[parameters('AzureSearchService')]"
                    },
                    {
                      "name": "AZURE_SEARCH_INDEX",
                      "value": "[parameters('AzureSearchIndex')]"
                    },
                    {
                      "name": "AZURE_SEARCH_KEY",
                      "value": "[parameters('AzureSearchKey')]"
                    },
                    {
                      "name": "AZURE_SEARCH_USE_SEMANTIC_SEARCH",
                      "value": "[parameters('AzureSearchUseSemanticSearch')]"
                    },
                    {
                      "name": "AZURE_SEARCH_SEMANTIC_SEARCH_CONFIG",
                      "value": "[parameters('AzureSearchSemanticSearchConfig')]"
                    },
                    {
                      "name": "AZURE_SEARCH_INDEX_IS_PRECHUNKED",
                      "value": "[parameters('AzureSearchIndexIsPrechunked')]"
                    },
                    {
                      "name": "AZURE_SEARCH_TOP_K",
                      "value": "[parameters('AzureSearchTopK')]"
                    },
                    {
                      "name": "AZURE_SEARCH_ENABLE_IN_DOMAIN",
                      "value": "[parameters('AzureSearchEnableInDomain')]"
                    },
                    {
                      "name": "AZURE_SEARCH_CONTENT_COLUMNS",
                      "value": "[parameters('AzureSearchContentColumns')]"
                    },
                    {
                      "name": "AZURE_SEARCH_FILENAME_COLUMN",
                      "value": "[parameters('AzureSearchFilenameColumn')]"
                    },
                    {
                      "name": "AZURE_SEARCH_TITLE_COLUMN",
                      "value": "[parameters('AzureSearchTitleColumn')]"
                    },
                    {
                      "name": "AZURE_SEARCH_URL_COLUMN",
                      "value": "[parameters('AzureSearchUrlColumn')]"
                    },
                    {
                      "name": "AZURE_OPENAI_RESOURCE",
                      "value": "[parameters('AzureOpenAIResource')]"
                    },
                    {
                      "name": "AZURE_OPENAI_MODEL",
                      "value": "[parameters('AzureOpenAIModel')]"
                    },
                    {
                      "name": "AZURE_OPENAI_ENDPOINT",
                      "value": "[parameters('AzureOpenAIEndpoint')]"
                    },
                    {
                      "name": "AZURE_OPENAI_KEY",
                      "value": "[parameters('AzureOpenAIKey')]"
                    },
                    {
                      "name": "AZURE_OPENAI_MODEL_NAME",
                      "value": "[parameters('AzureOpenAIModelName')]"
                    },
                    {
                      "name": "AZURE_OPENAI_TEMPERATURE",
                      "value": "[parameters('AzureOpenAITemperature')]"
                    },
                    {
                      "name": "AZURE_OPENAI_TOP_P",
                      "value": "[parameters('AzureOpenAITopP')]"
                    },
                    {
                      "name": "AZURE_OPENAI_MAX_TOKENS",
                      "value": "[parameters('AzureOpenAIMaxTokens')]"
                    },
                    {
                      "name": "AZURE_OPENAI_STOP_SEQUENCE",
                      "value": "[parameters('AzureOpenAIStopSequence')]"
                    },
                    {
                      "name": "AZURE_OPENAI_SYSTEM_MESSAGE",
                      "value": "[parameters('AzureOpenAISystemMessage')]"
                    },
                    {
                      "name": "AZURE_OPENAI_PREVIEW_API_VERSION",
                      "value": "[parameters('AzureOpenAIApiVersion')]"
                    },
                    {
                      "name": "AZURE_OPENAI_STREAM",
                      "value": "[parameters('AzureOpenAIStream')]"
                    },
                    {
                      "name": "AZURE_SEARCH_QUERY_TYPE",
                      "value": "[parameters('AzureSearchQueryType')]"
                    },
                    {
                      "name": "AZURE_SEARCH_VECTOR_COLUMNS",
                      "value": "[parameters('AzureSearchVectorFields')]"
                    },
                    {
                      "name": "AZURE_SEARCH_PERMITTED_GROUPS_COLUMN",
                      "value": "[parameters('AzureSearchPermittedGroupsField')]"
                    },
                    {
                      "name": "AZURE_SEARCH_STRICTNESS",
                      "value": "[parameters('AzureSearchStrictness')]"
                    },
                    {
                      "name": "AZURE_OPENAI_EMBEDDING_NAME",
                      "value": "[parameters('AzureOpenAIEmbeddingName')]"
                    },
                    {
                      "name": "AZURE_OPENAI_EMBEDDING_KEY",
                      "value": "[parameters('AzureOpenAIEmbeddingkey')]"
                    },
                    {
                      "name": "AZURE_OPENAI_EMBEDDING_ENDPOINT",
                      "value": "[parameters('AzureOpenAIEmbeddingEndpoint')]"
                    },
                    {
                      "name": "WEB_APP_ENABLE_CHAT_HISTORY",
                      "value": "[parameters('WebAppEnableChatHistory')]"
                    },
                    {
                      "name": "SQLDB_SERVER",
                      "value": "[parameters('SQLDB_SERVER')]"
                    },
                    {
                      "name": "SQLDB_DATABASE",
                      "value": "[parameters('SQLDB_DATABASE')]"
                    },
                    {
                      "name": "SQLDB_USERNAME",
                      "value": "[parameters('SQLDB_USERNAME')]"
                    },
                    {
                      "name": "SQLDB_PASSWORD",
                      "value": "[parameters('SQLDB_PASSWORD')]"
                    },
                    {
                      "name": "USE_AZUREFUNCTION",
                      "value": "[parameters('USE_AZUREFUNCTION')]"
                    },
                    {
                      "name": "STREAMING_AZUREFUNCTION_ENDPOINT",
                      "value": "[parameters('STREAMING_AZUREFUNCTION_ENDPOINT')]"
                    },
                    {
                      "name": "AZURE_COSMOSDB_ACCOUNT",
                      "value": "[parameters('AZURE_COSMOSDB_ACCOUNT')]"
                    },
                    {
                      "name": "AZURE_COSMOSDB_CONVERSATIONS_CONTAINER",
                      "value": "[parameters('AZURE_COSMOSDB_CONVERSATIONS_CONTAINER')]"
                    },
                    {
                      "name": "AZURE_COSMOSDB_DATABASE",
                      "value": "[parameters('AZURE_COSMOSDB_DATABASE')]"
                    },
                    {
                      "name": "AZURE_COSMOSDB_ENABLE_FEEDBACK",
                      "value": "[parameters('AZURE_COSMOSDB_ENABLE_FEEDBACK')]"
                    },
                    {
                      "name": "VITE_POWERBI_EMBED_URL",
                      "value": "[parameters('VITE_POWERBI_EMBED_URL')]"
                    },
                    {
                      "name": "SCM_DO_BUILD_DURING_DEPLOYMENT",
                      "value": "true"
                    },
                    {
                      "name": "UWSGI_PROCESSES",
                      "value": "2"
                    },
                    {
                      "name": "UWSGI_THREADS",
                      "value": "2"
                    }
                  ],
                  "linuxFxVersion": "[variables('WebAppImageName')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/components', parameters('ApplicationInsightsName'))]",
                "[resourceId('Microsoft.Web/serverfarms', parameters('HostingPlanName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('ApplicationInsightsName')]",
              "location": "[resourceGroup().location]",
              "tags": {
                "[format('hidden-link:{0}', resourceId('Microsoft.Web/sites', parameters('ApplicationInsightsName')))]": "Resource"
              },
              "properties": {
                "Application_Type": "web"
              },
              "kind": "web"
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('cosmos-sql-user-role-{0}', parameters('WebsiteName'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "accountName": {
                    "value": "[parameters('AZURE_COSMOSDB_ACCOUNT')]"
                  },
                  "roleDefinitionId": {
                    "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions', split(format('{0}/00000000-0000-0000-0000-000000000002', parameters('AZURE_COSMOSDB_ACCOUNT')), '/')[0], split(format('{0}/00000000-0000-0000-0000-000000000002', parameters('AZURE_COSMOSDB_ACCOUNT')), '/')[1])]"
                  },
                  "principalId": {
                    "value": "[reference(resourceId('Microsoft.Web/sites', parameters('WebsiteName')), '2020-06-01', 'full').identity.principalId]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.33.93.31351",
                      "templateHash": "8674928823795121669"
                    },
                    "description": "Creates a SQL role assignment under an Azure Cosmos DB account."
                  },
                  "parameters": {
                    "accountName": {
                      "type": "string"
                    },
                    "roleDefinitionId": {
                      "type": "string"
                    },
                    "principalId": {
                      "type": "string",
                      "defaultValue": ""
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
                      "apiVersion": "2022-05-15",
                      "name": "[format('{0}/{1}', parameters('accountName'), guid(parameters('roleDefinitionId'), parameters('principalId'), resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('accountName'))))]",
                      "properties": {
                        "principalId": "[parameters('principalId')]",
                        "roleDefinitionId": "[parameters('roleDefinitionId')]",
                        "scope": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('accountName'))]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('WebsiteName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy_azure_ai_service')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy_azure_open_ai')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy_ai_search_service')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy_azure_function_script_url')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_cosmos_db')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, resourceGroup().name), 'Microsoft.Resources/deployments', 'deploy_sql_db')]"
      ]
    }
  ]
}