# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: build-your-own-copilot-solution-accelerator

requiredVersions:
  azd: ">= 1.18.0"

metadata:
  template: build-your-own-copilot-solution-accelerator@1.0
  name: build-your-own-copilot-solution-accelerator@1.0

hooks:
  # Pre-package hook to set container registry variables
  prepackage:
    windows:
      run: |
        Write-Host "Setting up container registry variables..." -ForegroundColor Green
        
        # Get the ACR name from the deployed infrastructure
        $acrName = azd env get-values --output json | ConvertFrom-Json | Select-Object -ExpandProperty "AZURE_CONTAINER_REGISTRY_NAME" -ErrorAction SilentlyContinue
        
        if ($acrName) {
          Write-Host "Using deployed ACR: $acrName" -ForegroundColor Cyan
          azd env set AZURE_CONTAINER_REGISTRY_ENDPOINT "$acrName.azurecr.io"
          azd env set AZURE_CONTAINER_REGISTRY_NAME $acrName
        } else {
          Write-Host "Warning: ACR not found in environment. Make sure infrastructure is deployed first." -ForegroundColor Yellow
        }
      shell: pwsh
      continueOnError: true

    posix:
      run: |
        echo "Setting up container registry variables..."
        
        # Get the ACR name from the deployed infrastructure
        ACR_NAME=$(azd env get-values --output json | jq -r '.AZURE_CONTAINER_REGISTRY_NAME // empty')
        
        if [ ! -z "$ACR_NAME" ]; then
          echo "Using deployed ACR: $ACR_NAME"
          azd env set AZURE_CONTAINER_REGISTRY_ENDPOINT "$ACR_NAME.azurecr.io"
          azd env set AZURE_CONTAINER_REGISTRY_NAME "$ACR_NAME"
        else
          echo "Warning: ACR not found in environment. Make sure infrastructure is deployed first."
        fi
      shell: sh
      continueOnError: true

  # Pre-deploy hook to build and push containers
  predeploy:
    windows:
      run: |
        Write-Host "üöÄ Starting container deployment process..." -ForegroundColor Green
        
        # Get environment variables from azd
        $acrName = azd env get-value AZURE_CONTAINER_REGISTRY_NAME
        $resourceGroup = azd env get-value AZURE_RESOURCE_GROUP
        $webAppName = azd env get-value WEB_APP_NAME
        $imageName = "byc-wa-app"
        $imageTag = "latest"
        
        if (-not $acrName) {
            Write-Host "‚ùå Error: AZURE_CONTAINER_REGISTRY_NAME not set. Run 'azd provision' first." -ForegroundColor Red
            exit 1
        }
        
        if (-not $resourceGroup) {
            Write-Host "‚ùå Error: AZURE_RESOURCE_GROUP not set. Run 'azd provision' first." -ForegroundColor Red
            exit 1
        }
        
        if (-not $webAppName) {
            Write-Host "‚ùå Error: WEB_APP_NAME not set. Run 'azd provision' first." -ForegroundColor Red
            exit 1
        }
        
        Write-Host "üìã Configuration:" -ForegroundColor Cyan
        Write-Host "   ACR Name: $acrName" -ForegroundColor White
        Write-Host "   Resource Group: $resourceGroup" -ForegroundColor White
        Write-Host "   Web App: $webAppName" -ForegroundColor White
        Write-Host "   Image: $imageName`:$imageTag" -ForegroundColor White
        
        # Login to ACR
        Write-Host "üîê Logging into ACR..." -ForegroundColor Yellow
        az acr login --name $acrName
        
        if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Failed to login to ACR" -ForegroundColor Red
            exit 1
        }
        
        # Build and push the container image
        Write-Host "üèóÔ∏è  Building container image..." -ForegroundColor Yellow
        $fullImageName = "$acrName.azurecr.io/$imageName`:$imageTag"
        docker build -f "./src/App/WebApp.Dockerfile" -t $fullImageName "./src"
        
        if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Failed to build container image" -ForegroundColor Red
            exit 1
        }
        
        Write-Host "üì§ Pushing container image to ACR..." -ForegroundColor Yellow
        docker push $fullImageName
        
        if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Failed to push container image" -ForegroundColor Red
            exit 1
        }
        
        # Update environment variables
        Write-Host "üîß Updating azd environment variables..." -ForegroundColor Yellow
        azd env set CONTAINER_REGISTRY_HOSTNAME "$acrName.azurecr.io"
        azd env set CONTAINER_IMAGE_NAME $imageName
        azd env set IMAGE_TAG $imageTag
        
        # Configure web app ACR authentication using managed identity
        Write-Host "üîë Configuring ACR authentication for web app..." -ForegroundColor Yellow
        $webappIdentity = az webapp identity show --name $webAppName --resource-group $resourceGroup --query principalId --output tsv
        
        if (-not $webappIdentity -or $webappIdentity -eq "null") {
            Write-Host "üîÑ Enabling managed identity for web app..." -ForegroundColor Yellow
            $webappIdentity = az webapp identity assign --name $webAppName --resource-group $resourceGroup --query principalId --output tsv
        }
        
        Write-Host "   Web app identity: $webappIdentity" -ForegroundColor White
        
        # Assign AcrPull role to web app managed identity
        Write-Host "üîê Assigning AcrPull role to web app..." -ForegroundColor Yellow
        $acrResourceId = az acr show --name $acrName --resource-group $resourceGroup --query id --output tsv
        az role assignment create --assignee $webappIdentity --role AcrPull --scope $acrResourceId
        if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ö†Ô∏è  Role assignment may already exist" -ForegroundColor Yellow
        }
        
        # Configure web app to use ACR with managed identity
        Write-Host "üîß Configuring web app container settings..." -ForegroundColor Yellow
        az webapp config appsettings set --name $webAppName --resource-group $resourceGroup --settings `
            DOCKER_REGISTRY_SERVER_URL="https://$acrName.azurecr.io" `
            DOCKER_ENABLE_CI=true
        
        # Configure web app to use managed identity for ACR authentication
        Write-Host "üîê Enabling ACR managed identity authentication..." -ForegroundColor Yellow
        az webapp config set --name $webAppName --resource-group $resourceGroup --acr-use-identity true
        
        # Update web app to use the new container image
        Write-Host "üöÄ Updating web app container image..." -ForegroundColor Yellow
        $dockerImage = "DOCKER|$fullImageName"
        
        # Use cmd to avoid PowerShell pipe interpretation issues
        $cmd = "az webapp config set --name `"$webAppName`" --resource-group `"$resourceGroup`" --linux-fx-version `"$dockerImage`""
        cmd /c $cmd
        
        if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Failed to update web app configuration" -ForegroundColor Red
            exit 1
        }
        
        # Restart the web app to ensure it picks up the new configuration
        Write-Host "üîÑ Restarting web app..." -ForegroundColor Yellow
        az webapp restart --name $webAppName --resource-group $resourceGroup
        
        Write-Host "‚úÖ Container deployment completed successfully!" -ForegroundColor Green
        Write-Host "üåê Web app URL: https://$webAppName.azurewebsites.net" -ForegroundColor Cyan
        Write-Host "üì¶ Container image: $fullImageName" -ForegroundColor Cyan
        
        Write-Host ""
        Write-Host "‚è≥ The web app may take a few minutes to start up with the new container..." -ForegroundColor Yellow
        Write-Host "   You can monitor the logs with:" -ForegroundColor White
        Write-Host "   az webapp log tail --name $webAppName --resource-group $resourceGroup" -ForegroundColor Cyan
      shell: pwsh
      continueOnError: false

    posix:
      run: |
        echo "üöÄ Starting container deployment process..."
        
        # Get environment variables from azd
        ACR_NAME=$(azd env get-value AZURE_CONTAINER_REGISTRY_NAME)
        RESOURCE_GROUP=$(azd env get-value AZURE_RESOURCE_GROUP)
        WEB_APP_NAME=$(azd env get-value WEB_APP_NAME)
        IMAGE_TAG="latest"
        IMAGE_NAME="byc-wa-app"
        
        if [ -z "$ACR_NAME" ]; then
            echo "‚ùå Error: AZURE_CONTAINER_REGISTRY_NAME not set. Run 'azd provision' first."
            exit 1
        fi
        
        if [ -z "$RESOURCE_GROUP" ]; then
            echo "‚ùå Error: AZURE_RESOURCE_GROUP not set. Run 'azd provision' first."
            exit 1
        fi
        
        if [ -z "$WEB_APP_NAME" ]; then
            echo "‚ùå Error: WEB_APP_NAME not set. Run 'azd provision' first."
            exit 1
        fi
        
        echo "üìã Configuration:"
        echo "   ACR Name: $ACR_NAME"
        echo "   Resource Group: $RESOURCE_GROUP"
        echo "   Web App: $WEB_APP_NAME"
        echo "   Image: $IMAGE_NAME:$IMAGE_TAG"
        
        # Login to ACR
        echo "üîê Logging into ACR..."
        az acr login --name $ACR_NAME
        
        # Build and push the container image
        echo "üèóÔ∏è  Building container image..."
        FULL_IMAGE_NAME="$ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG"
        docker build -f "./src/App/WebApp.Dockerfile" -t $FULL_IMAGE_NAME "./src"
        
        echo "üì§ Pushing container image to ACR..."
        docker push $FULL_IMAGE_NAME
        
        # Update environment variables
        echo "üîß Updating azd environment variables..."
        azd env set CONTAINER_REGISTRY_HOSTNAME "$ACR_NAME.azurecr.io"
        azd env set CONTAINER_IMAGE_NAME $IMAGE_NAME
        azd env set IMAGE_TAG $IMAGE_TAG
        
        # Configure web app ACR authentication using managed identity
        echo "üîë Configuring ACR authentication for web app..."
        WEBAPP_IDENTITY=$(az webapp identity show --name $WEB_APP_NAME --resource-group $RESOURCE_GROUP --query principalId --output tsv)
        
        if [ -z "$WEBAPP_IDENTITY" ] || [ "$WEBAPP_IDENTITY" = "null" ]; then
            echo "üîÑ Enabling managed identity for web app..."
            WEBAPP_IDENTITY=$(az webapp identity assign --name $WEB_APP_NAME --resource-group $RESOURCE_GROUP --query principalId --output tsv)
        fi
        
        echo "   Web app identity: $WEBAPP_IDENTITY"
        
        # Assign AcrPull role to web app managed identity
        echo "üîê Assigning AcrPull role to web app..."
        ACR_RESOURCE_ID=$(az acr show --name $ACR_NAME --resource-group $RESOURCE_GROUP --query id --output tsv)
        az role assignment create --assignee $WEBAPP_IDENTITY --role AcrPull --scope $ACR_RESOURCE_ID || echo "‚ö†Ô∏è  Role assignment may already exist"
        
        # Configure web app to use ACR with managed identity
        echo "üîß Configuring web app container settings..."
        az webapp config appsettings set --name $WEB_APP_NAME --resource-group $RESOURCE_GROUP --settings \
            DOCKER_REGISTRY_SERVER_URL="https://$ACR_NAME.azurecr.io" \
            DOCKER_ENABLE_CI=true
        
        # Configure web app to use managed identity for ACR authentication  
        echo "üîê Enabling ACR managed identity authentication..."
        az webapp config set --name $WEB_APP_NAME --resource-group $RESOURCE_GROUP --acr-use-identity true
        
        # Update web app to use the new container image
        echo "üöÄ Updating web app container image..."
        DOCKER_IMAGE="DOCKER|$FULL_IMAGE_NAME"
        az webapp config set --name $WEB_APP_NAME --resource-group $RESOURCE_GROUP --linux-fx-version "$DOCKER_IMAGE"
        
        # Restart the web app to ensure it picks up the new configuration
        echo "üîÑ Restarting web app..."
        az webapp restart --name $WEB_APP_NAME --resource-group $RESOURCE_GROUP
        
        echo "‚úÖ Container deployment completed successfully!"
        echo "üåê Web app URL: https://$WEB_APP_NAME.azurewebsites.net"
        echo "üì¶ Container image: $FULL_IMAGE_NAME"
        
        echo ""
        echo "‚è≥ The web app may take a few minutes to start up with the new container..."
        echo "   You can monitor the logs with:"
        echo "   az webapp log tail --name $WEB_APP_NAME --resource-group $RESOURCE_GROUP"
      shell: sh
      continueOnError: false

  postprovision:
    windows:
      run: |
        Write-Host "Deployment completed successfully!" -ForegroundColor Green
        Write-Host "Web app URL: " -NoNewline
        Write-Host "$env:WEB_APP_URL" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "Container Registry: " -NoNewline
        Write-Host "$env:AZURE_CONTAINER_REGISTRY_NAME.azurecr.io" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "Next steps:" -ForegroundColor Yellow
        Write-Host "1. Run the following command to grant permissions and load sample data:" -ForegroundColor White
        Write-Host "   bash ./infra/scripts/process_sample_data.sh $env:AZURE_RESOURCE_GROUP" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "2. For local development, see ./docs/LocalDevelopmentGuide.md" -ForegroundColor White
        Write-Host ""
        Write-Host "3. To build and deploy custom containers:" -ForegroundColor White
        Write-Host "   azd deploy" -ForegroundColor Cyan
      shell: pwsh
      continueOnError: false
      interactive: true

    posix:
      run: |
        echo "Deployment completed successfully!"
        echo "Web app URL: $WEB_APP_URL"
        echo ""
        echo "Container Registry: $AZURE_CONTAINER_REGISTRY_NAME.azurecr.io"
        echo ""
        echo "Next steps:"
        echo "1. Run the following command to grant permissions and load sample data:"
        echo "   bash ./infra/scripts/process_sample_data.sh $AZURE_RESOURCE_GROUP"
        echo ""
        echo "2. For local development, see ./docs/LocalDevelopmentGuide.md"
        echo ""
        echo "3. To build and deploy custom containers:"
        echo "   azd deploy"
      shell: sh
      continueOnError: false
      interactive: true

  postdeploy:
    windows:
      run: |
        Write-Host "‚úÖ Deployment completed! Container deployment was handled by predeploy hook." -ForegroundColor Green
        $webAppUrl = azd env get-value WEB_APP_URL
        Write-Host "üåê Web app URL: $webAppUrl" -ForegroundColor Cyan
      shell: pwsh
      continueOnError: true

    posix:
      run: |
        echo "‚úÖ Deployment completed! Container deployment was handled by predeploy hook."
        WEB_APP_URL=$(azd env get-value WEB_APP_URL)
        echo "üåê Web app URL: $WEB_APP_URL"
      shell: sh
      continueOnError: true

# Infrastructure configuration
infra:
  provider: bicep
  path: infra
  module: main.bicep
  parameters:
    containerRegistryHostname: ${CONTAINER_REGISTRY_HOSTNAME=""}
    containerImageName: ${CONTAINER_IMAGE_NAME="byc-wa-app"}
    imageTag: ${IMAGE_TAG="latest"}