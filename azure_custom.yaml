# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json
name: byoc-research-assistant-custom

requiredVersions:
  azd: ">= 1.18.0"

metadata:
  template: byoc-research-assistant-custom@1.0

infra:
  provider: bicep
  path: infra
  module: main

services:
  webapp:
    project: ./src
    language: py
    host: appservice
    dist: ./dist
    hooks:
      prepackage:
        windows:
          shell: pwsh
          run: ../infra/scripts/package_webapp.ps1
          interactive: true
          continueOnError: false
        posix:
          shell: sh
          run: bash ../infra/scripts/package_webapp.sh
          interactive: true
          continueOnError: false
      postdeploy:
        windows:
          shell: pwsh
          run: |
            Write-Host ""
            Write-Host "üîÑ Configuring App Service for code deployment..."
            $rgName = (azd env get-value AZURE_RESOURCE_GROUP)
            if ($rgName) {
              $appName = (az webapp list --resource-group $rgName --query "[?kind=='app,linux'].name" -o tsv)
              if ($appName) {
                Write-Host "  Found App Service: $appName in $rgName"
                Write-Host "  Setting Python 3.11 runtime and startup command..."
                az webapp config set --resource-group $rgName --name $appName --linux-fx-version `"PYTHON`|3.11`" --startup-file "gunicorn --bind=0.0.0.0:8000 --timeout 600 app:app" --output none
                Write-Host "  Restarting App Service..."
                az webapp restart --resource-group $rgName --name $appName --output none
                Write-Host "  ‚úÖ App Service configured and restarted"
              } else {
                Write-Host "  ‚ö†Ô∏è  Could not find App Service"
              }
            } else {
              Write-Host "  ‚ö†Ô∏è  Could not determine resource group"
            }
            Write-Host ""
          interactive: true
          continueOnError: true
        posix:
          shell: sh
          run: |
            echo ""
            echo "üîÑ Configuring App Service for code deployment..."
            RG_NAME=$(azd env get-value AZURE_RESOURCE_GROUP)
            if [ ! -z "$RG_NAME" ]; then
              APP_NAME=$(az webapp list --resource-group "$RG_NAME" --query "[?kind=='app,linux'].name" -o tsv)
              if [ ! -z "$APP_NAME" ]; then
                echo "  Found App Service: $APP_NAME in $RG_NAME"
                echo "  Setting Python 3.11 runtime and startup command..."
                az webapp config set --resource-group "$RG_NAME" --name "$APP_NAME" --linux-fx-version "PYTHON|3.11" --startup-file "gunicorn --bind=0.0.0.0:8000 --timeout 600 app:app" --output none
                echo "  Restarting App Service..."
                az webapp restart --resource-group "$RG_NAME" --name "$APP_NAME" --output none
                echo "  ‚úÖ App Service configured and restarted"
              else
                echo "  ‚ö†Ô∏è  Could not find App Service"
              fi
            else
              echo "  ‚ö†Ô∏è  Could not determine resource group"
            fi
            echo ""
          interactive: true
          continueOnError: true

hooks:
  postprovision:
    windows:
      run: |
        Write-Host "‚úÖ Infrastructure provisioned successfully!"
        $webAppUrl = azd env get-value WEB_APP_URL
        if ($webAppUrl) {
          Write-Host "Web app URL: $webAppUrl"
        }
      shell: pwsh
      continueOnError: true
    posix:
      run: |
        echo "‚úÖ Infrastructure provisioned successfully!"
        WEB_APP_URL=$(azd env get-value WEB_APP_URL)
        if [ ! -z "$WEB_APP_URL" ]; then
          echo "Web app URL: $WEB_APP_URL"
        fi
      shell: sh
      continueOnError: true
